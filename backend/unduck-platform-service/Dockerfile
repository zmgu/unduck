#########################################
# ğŸ”¹ Stage 1 â€” Build Spring Boot JAR
#########################################
FROM gradle:8.5-jdk17-alpine AS builder
WORKDIR /workspace

# Gradle ìºì‹œ ë³µì‚¬(ì„ íƒì‚¬í•­)
COPY build.gradle settings.gradle gradlew ./
COPY gradle ./gradle

# ë‚˜ë¨¸ì§€ í”„ë¡œì íŠ¸ ë³µì‚¬
COPY . .

# ì‹¤í–‰ ê¶Œí•œ ë° ë¹Œë“œ
RUN chmod +x gradlew && ./gradlew --no-daemon clean bootJar


#########################################
# ğŸ”¹ Stage 2 â€” Runtime
#########################################
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# Config Server ì—°ë™ ì‹œ bootstrap.yml ëˆ„ë½ ë°©ì§€
COPY src/main/resources/ /app/resources/

# ë¹Œë“œëœ JAR ë³µì‚¬
COPY --from=builder /workspace/build/libs/*-SNAPSHOT.jar app.jar

# JVM ì˜µì…˜(í•„ìš” ì‹œ í™˜ê²½ë³€ìˆ˜ë¡œ ëŒ€ì²´ ê°€ëŠ¥)
ENV JAVA_OPTS="-Xms256m -Xmx512m"

EXPOSE 8080

# ì‹¤í–‰
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
