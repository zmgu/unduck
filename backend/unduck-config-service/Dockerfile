#########################################
# ğŸ”¹ Stage 1 â€” Build Spring Boot JAR
#########################################
FROM gradle:8.7.0-jdk17-jammy AS builder
WORKDIR /workspace

# Gradle ì„¤ì • ë³µì‚¬
COPY gradlew ./
COPY gradle ./gradle
COPY build.gradle settings.gradle ./

# ì†ŒìŠ¤ ë³µì‚¬
COPY src ./src

# ë¹Œë“œ
RUN chmod +x gradlew && ./gradlew --no-daemon clean bootJar


#########################################
# ğŸ”¹ Stage 2 â€” Runtime
#########################################
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# âœ… í•„ìˆ˜ ìœ í‹¸ ì„¤ì¹˜ (curl, grep)
RUN apk add --no-cache curl grep

# ë¹Œë“œëœ JAR ë³µì‚¬
COPY --from=builder /workspace/build/libs/*.jar app.jar

# JVM ì˜µì…˜ (í•„ìš” ì‹œ ì¡°ì • ê°€ëŠ¥)
ENV JAVA_OPTS="-Xms256m -Xmx512m"

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8888

# âœ… Healthcheck ìš©ë„ë¡œ curl ë™ì‘ í™•ì¸
HEALTHCHECK --interval=10s --timeout=5s --retries=15 --start-period=100s \
  CMD test "$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8888/actuator/health)" = "200"


# ì‹¤í–‰
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
